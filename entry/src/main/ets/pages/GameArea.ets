import promptAction from '@ohos.promptAction';
import { BusinessError } from '@ohos.base';
import { Animator } from '@kit.ArkUI';
import animator, { AnimatorResult } from '@ohos.animator';


interface Position {
  x: number;
y: number;
}

// å®šä¹‰æ•Œäººçš„æ•°æ®ç±»å‹
interface EnemyDataType {
  avatar: string;
  name: string;
}

// å®šä¹‰å®ç®±å¥–åŠ±çš„æ•°æ®ç±»å‹
interface RewardData {
  type: 'gold' | 'weapon' | 'keyItem';
  amount?: number; // å¯¹äºé‡‘å¸ï¼Œè¡¨ç¤ºè·å¾—çš„é‡‘å¸æ•°é‡
  name?: string; // å¯¹äºæ­¦å™¨å’Œä»»åŠ¡é“å…·ï¼Œè¡¨ç¤ºåç§°
  description?: string; // å¯¹äºæ­¦å™¨å’Œä»»åŠ¡é“å…·ï¼Œè¡¨ç¤ºæè¿°
}

interface CharacterData {
  type: 'player' | 'enemy' | 'npc' | 'treasure'; // è§’è‰²ç±»å‹
name: string; // è§’è‰²åç§°
level: number; // è§’è‰²ç­‰çº§
class: string; // è§’è‰²èŒä¸š
hp: number; // å½“å‰ç”Ÿå‘½å€¼
maxHp: number; // æœ€å¤§ç”Ÿå‘½å€¼
mp: number; // å½“å‰é­”æ³•å€¼
maxMp: number; // æœ€å¤§é­”æ³•å€¼
strength: number; // åŠ›é‡å±æ€§
dexterity: number; // æ•æ·å±æ€§
intelligence: number; // æ™ºåŠ›å±æ€§
avatar: string; // è§’è‰²å¤´åƒèµ„æºè·¯å¾„
position: Position; // è§’è‰²å½“å‰ä½ç½®
direction: 'up' | 'down' | 'left' | 'right' | null; // è§’è‰²ç§»åŠ¨æ–¹å‘ï¼Œnull è¡¨ç¤ºé™æ­¢
collisionRadius: number; // è§’è‰²ç¢°æ’åŠå¾„
  exp: number; // å½“å‰ç»éªŒå€¼
  nextLevelExp: number; //å‡çº§æ‰€éœ€çš„ç»éªŒå€¼
  inventory: ItemData[]; // è§’è‰²çš„èƒŒåŒ…
  live: boolean;
}

interface ItemData {
  name: string; // é“å…·åç§°
  description: string; // é“å…·æè¿°
  type: 'consumable' | 'equipment' | 'keyItem'; // é“å…·ç±»å‹
  effect: (character: CharacterData) => void; // é“å…·æ•ˆæœå‡½æ•°
}

@Component
export struct GameArea {

  @State isFlipped: boolean = false;
  @State renderTrigger: number = 0;
  @State battleReportPositionY: number = 0;
  @State battleReportTargetY: number = 0;
  @State characterPositionKey: number = 0;
  @State buttonPressed: string | null = null; // è®°å½•å½“å‰æŒ‰ä¸‹çš„æŒ‰é’®
  @State characterSpeed: number = 2; // è§’è‰²ç§»åŠ¨é€Ÿåº¦
  @State joystickAnimator: AnimatorResult | undefined = undefined;
  @State timer: number = 0;

  @State enemyAndTreasureNames: Map<number, string> = new Map(); // ç”¨äºå­˜å‚¨æ•Œäººå’Œå®ç®±çš„åå­—
  @State battleReportAboveEnemy: Map<CharacterData, string> = new Map(); // ç”¨äºå­˜å‚¨è¦æ˜¾ç¤ºåœ¨æ•Œäººå¤´ä¸Šçš„æˆ˜æ–—æŠ¥å‘Š

  @State battleReportAbovePlayer: string = ''; // ç©å®¶å¤´é¡¶çš„æˆ˜æ–—æŠ¥å‘Š
  @State isPlayerStopped: boolean = true; // ç©å®¶æ˜¯å¦åœæ­¢ç§»åŠ¨
  @State playerScaleX: number = 1; // ç©å®¶å›¾ç‰‡çš„ X è½´ç¼©æ”¾æ¯”ä¾‹
  @State actionStart: boolean = false; // äº‹ä»¶å¼€å§‹æ ‡è¯†
  @State actionEnd: boolean = true; // äº‹ä»¶ç»“æŸæ ‡è¯†

  @State gameAreaWidth: number = 450; // è®¾ç½®æ¸¸æˆåŒºåŸŸçš„å®½åº¦
  @State gameAreaHeight: number = 600; // è®¾ç½®æ¸¸æˆåŒºåŸŸçš„é«˜åº¦

  @State joystickX: number = 0; // joystick çš„ x åæ ‡ï¼ˆä¸å—é™åˆ¶ï¼‰
  @State joystickY: number = 0; // joystick çš„ y åæ ‡ï¼ˆä¸å—é™åˆ¶ï¼‰
  @State offsetX: number = 0; // joystick æŒ‡ç¤ºå™¨çš„ x åç§»é‡ï¼ˆå—é™åˆ¶ï¼‰
  @State offsetY: number = 0; // joystick æŒ‡ç¤ºå™¨çš„ y åç§»é‡ï¼ˆå—é™åˆ¶ï¼‰
  @State isDragging: boolean = false; // æ˜¯å¦æ­£åœ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨
  private panOption: PanGestureOptions = new PanGestureOptions({ direction: PanDirection.All });

  @State numEnemy: number =0;
  @State numTreasure: number = 0;
  @State numNpc: number = 0;


  @State dialogMessage: string = '';
  @State dialogTitle: string = '';
  @State npcDialogMessage: string = '';
  @State showMoveDialog: boolean = false;
  // æ˜¾ç¤ºå¼¹çª—çš„å‡½æ•°
  showDialog() {
    if (this.dialogMessage !== '') {
      try {
        promptAction.showDialog({
          title: this.dialogTitle,
          message: this.dialogMessage,
          buttons: []
        });
      } catch (error) {
        let message = (error as BusinessError).message;
        let code = (error as BusinessError).code;
        console.error(`showDialog args error code is ${code}, message is ${message}`);
      }
    }
  }

  @State someStateVariable: number = 0;
  private updateState: () => void = () => {};

  constructor() {
    super();
    this.updateState = () => {
      this.someStateVariable++; // ä¿®æ”¹ someStateVariable çš„å€¼ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“

    }; // åˆå§‹åŒ– updateState å˜é‡
  }

  onInit() {
    // åœ¨ç»„ä»¶åŠ è½½æ—¶ç”Ÿæˆæ•Œäººå’Œå®ç®±
    this.generateRandomEntities();

  }
  // åœ¨ onDestroy ä¸­åœæ­¢å®šæ—¶å™¨
  onDestroy() {

  }
  aboutToDisappear() {// åœ¨ç»„ä»¶é”€æ¯æ—¶åœæ­¢åŠ¨ç”»ï¼Œé¿å…å†…å­˜æ³„æ¼
    if (this.joystickAnimator) {
      this.joystickAnimator = undefined;
    }
  }


  //åˆå§‹åŒ–è§’è‰²ã€ç‰©å“å±æ€§
  @State characters: CharacterData []= [
    {
    // ... è§’è‰²æ•°æ® ...
    position: { x: 180, y: 100 } ,
    name: '',
    level: 0,
    class: '',
    hp: 50,
    maxHp: 100,
    mp: 5,
    maxMp: 5,
    strength: 80,
    dexterity: 5,
    intelligence: 3,
    avatar: '',
    direction: null,
    collisionRadius: 25,
      type: 'player',
      exp: 30,
      nextLevelExp: 100,
      inventory: [],
      live: true
  },];

  @State isMoving: boolean = false; // æ˜¯å¦æ­£åœ¨ç§»åŠ¨
  // è§’è‰²ç§»åŠ¨
  moveCharacter(direction: string) {

    // æ£€æŸ¥ç©å®¶æ˜¯å¦è¿˜æ´»ç€
    if (this.characters[0].hp == 0) {
      this.dialogTitle = 'â˜ æ­»äº¡å¼¹çª—â˜ ';
      this.dialogMessage = 'ä½ å·²ç»æ­»äº¡äº†ï¼æ— æ³•ç§»åŠ¨';
      this.showDialog();
      return;
    }

    // æ›´æ–° isFlipped çŠ¶æ€å˜é‡
    if (direction === 'left') {
      this.isFlipped = true;
    } else if (direction === 'right') {
      this.isFlipped = false;
    }

    // è®¾ç½®å›ºå®šçš„ç§»åŠ¨è·ç¦»
    const fixedSpeed = 25; // ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªå€¼

    // è®¾ç½® isPlayerStopped ä¸º falseï¼Œè¡¨ç¤ºè§’è‰²æ­£åœ¨ç§»åŠ¨
    this.isPlayerStopped = false;

    // è§’è‰²ç§»åŠ¨å‰æ¸…ç©ºæˆ˜æ–—æŠ¥å‘Š
    this.battleReportAbovePlayer = '';


    // è®¡ç®—è§’è‰²åœ¨ x å’Œ y æ–¹å‘ä¸Šçš„ç§»åŠ¨è·ç¦»
    let dx = 0;
    let dy = 0;
    switch (direction) {
      case 'up':
        dy = -fixedSpeed;
        break;
      case 'down':
        dy = fixedSpeed;
        break;
      case 'left':
        dx = -fixedSpeed;
        break;
      case 'right':
        dx = fixedSpeed;
        break;
    }

    // æ›´æ–°è§’è‰²çš„ä½ç½®
    const newCharacterX: number = this.characters[0].position.x + dx;
    const newCharacterY: number = this.characters[0].position.y + dy;


    // ä½¿ç”¨ animateTo å¹³æ»‘è¿‡æ¸¡åˆ°æ–°çš„è§’è‰²ä½ç½®
    animateTo({ duration: 100 }, () => {
      this.characters[0].position.x = newCharacterX;
      this.characters[0].position.y = newCharacterY;
      this.updateState(); // åœ¨åŠ¨ç”»ç»“æŸåè°ƒç”¨ updateState
    });

    // æ›´æ–° characterPositionKey ä»¥å¼ºåˆ¶åˆ·æ–°è§’è‰²å›¾ç‰‡
    this.characterPositionKey++;

    // å¤„ç†è¾¹ç•Œç¢°æ’
    const gameAreaWidth = this.gameAreaWidth; // æ›¿æ¢æˆä½ çš„æ¸¸æˆåŒºåŸŸå®½åº¦
    const gameAreaHeight = this.gameAreaHeight; // æ›¿æ¢æˆä½ çš„æ¸¸æˆåŒºåŸŸé«˜åº¦
    const characterWidth = 50; // æ›¿æ¢æˆä½ çš„è§’è‰²å®½åº¦
    const characterHeight = 50; // æ›¿æ¢æˆä½ çš„è§’è‰²é«˜åº¦

    if (this.characters[0].position.x < 0) {
      this.characters[0].position.x = 0;
    } else if (this.characters[0].position.x + characterWidth > gameAreaWidth) {
      this.characters[0].position.x = gameAreaWidth - characterWidth;
    }

    if (this.characters[0].position.y < 0) {
      this.characters[0].position.y = 0;
    } else if (this.characters[0].position.y + characterHeight > gameAreaHeight) {
      this.characters[0].position.y = gameAreaHeight - characterHeight;
    }

    // è®¾ç½® isPlayerStopped ä¸º trueï¼Œè¡¨ç¤ºè§’è‰²åœæ­¢ç§»åŠ¨
    this.isPlayerStopped = true;

    this.generateRandomEntities();
    this.checkCollisions();

    if (this.shouldStartBattle) {
      // è·å–æ•Œäººåœ¨ characters æ•°ç»„ä¸­çš„ç´¢å¼•
      const enemyIndex = this.characters.indexOf(this.battleTarget!);
      if (enemyIndex > -1) {
        // å¼€å§‹æˆ˜æ–—ï¼Œå¹¶å°†æ•Œäººå’Œæ•Œäººç´¢å¼•ä¼ é€’ç»™ startBattle å‡½æ•°
        this.startBattle(this.battleTarget!, enemyIndex);
      }
      this.shouldStartBattle = false;
      this.battleTarget = null;
    }

    this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // éšæœºç”Ÿæˆæ•Œäººå’Œå®ç®±çš„æ–¹æ³•
  generateRandomEntities() {

    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ•°ç»„æ¥å­˜å‚¨æ­£åœ¨ç”Ÿæˆçš„æ•Œäººå’Œå®ç®±
    const newCharacters: CharacterData[] = [];

    // é¦–å…ˆï¼Œæ£€æŸ¥æ‰€æœ‰ç°æœ‰çš„æ•Œäººå’Œå®ç®±æ˜¯å¦é‡å 
    for (let i = 0; i < this.characters.length; i++) {
      for (let j = i + 1; j < this.characters.length; j++) {
        const character1 = this.characters[i];
        const character2 = this.characters[j];

        // åªæ£€æŸ¥æ•Œäººå’Œå®ç®±
        if ((character1.type === 'enemy' || character1.type === 'treasure') &&
          (character2.type === 'enemy' || character2.type === 'treasure')) {
          // è®¡ç®—è§’è‰²ä¹‹é—´çš„è·ç¦»
          const distance = Math.sqrt(
            Math.pow(character1.position.x - character2.position.x, 3) +
            Math.pow(character1.position.y - character2.position.y, 3)
          );

          // å¦‚æœè·ç¦»å°äºä¸¤ä¸ªè§’è‰²çš„ç¢°æ’åŠå¾„ä¹‹å’Œï¼Œåˆ™å°†å…¶ä¸­ä¸€ä¸ªè§’è‰²çš„ä½ç½®éšæœºåŒ–
          if (distance < character1.collisionRadius + character2.collisionRadius) {
            // éšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²è¿›è¡Œä½ç½®éšæœºåŒ–
            const characterToRandomize = Math.random() < 0.5 ? character1 : character2;
            do {
              characterToRandomize.position = {
                x: Math.floor(Math.random() * (this.gameAreaWidth - 75)),
                y: Math.floor(Math.random() * (this.gameAreaHeight - 75))
              };} while (this.isCharacterOverlapping(characterToRandomize, this.characters)); // ç¡®ä¿æ–°çš„ä½ç½®ä¸ä¸å…¶ä»–è§’è‰²é‡å 
          }
        }
      }
    }

    // è®¡ç®—å‰©ä½™å¯ç”Ÿæˆçš„æ•Œäººæ•°é‡
    const remainingEnemies = 5 - this.numEnemy;
    // éšæœºç”Ÿæˆ 0 åˆ° 3 ä¸ªæ•Œäººï¼Œä½†ä¸è¶…è¿‡å‰©ä½™å¯ç”Ÿæˆçš„æ•Œäººæ•°é‡
    const numEnemiesToGenerate = Math.min(Math.floor(Math.random() * 4), remainingEnemies);
    for (let i= 0; i < numEnemiesToGenerate; i++) {
      let enemy: CharacterData;
      let isOverlapping: boolean;
      do {
        // éšæœºé€‰æ‹©æ•Œäººå›¾ç‰‡å’Œåå­—
        const enemyData: EnemyDataType[] = [
          { avatar: 'app.media.samurai', name: 'å‰‘å®¢' },
          { avatar: 'app.media.gunnery', name: 'æªæ‰‹' },
          { avatar: 'app.media.magician', name: 'æ³•å¸ˆ' }
        ];
        const randomIndex = Math.floor(Math.random() * enemyData.length);
        const randomData = enemyData[randomIndex];

        enemy = {
          type: 'enemy',
          name: randomData.name + ' ' + (this.numEnemy + 1), // ä½¿ç”¨éšæœºé€‰æ‹©çš„åå­—
          level: Math.floor(Math.random() * 5) + 1,
          class: '',
          hp: 50 + Math.floor(Math.random() * 50), // åŸºç¡€ç”Ÿå‘½å€¼ 50ï¼Œéšæœºå¢åŠ  0-49
          maxHp: 100 + Math.floor(Math.random() * 50), // åŸºç¡€æœ€å¤§ç”Ÿå‘½å€¼ 100ï¼Œéšæœºå¢åŠ  0-49
          mp: 0,
          maxMp: 0,
          strength: 20 + Math.floor(Math.random() * 20), // åŸºç¡€åŠ›é‡ 20ï¼Œéšæœºå¢åŠ  0-19
          dexterity: 5 + Math.floor(Math.random() * 5), // åŸºç¡€æ•æ· 5ï¼Œéšæœºå¢åŠ  0-5
          intelligence: 3 + Math.floor(Math.random() * 5), // åŸºç¡€æ™ºåŠ› 3ï¼Œéšæœºå¢åŠ  0-5
          avatar: randomData.avatar, // ä½¿ç”¨éšæœºé€‰æ‹©çš„å›¾ç‰‡
          position: {
            x: Math.floor(Math.random() * (this.gameAreaWidth - 75)),
            y: Math.floor(Math.random() * (this.gameAreaHeight - 75))
          },
          direction: null,
          collisionRadius: 25,
          exp:0, // åˆå§‹ç»éªŒå€¼
          nextLevelExp: 100, // å‡çº§æ‰€éœ€ç»éªŒå€¼
          inventory: [], // åˆå§‹ç©ºèƒŒåŒ…
          live: true,
        };

        // æ£€æŸ¥æ–°ç”Ÿæˆçš„æ•Œäººæ˜¯å¦ä¸ç°æœ‰è§’è‰²æˆ–æ­£åœ¨ç”Ÿæˆçš„æ•Œäººå’Œå®ç®±é‡å 
        isOverlapping = this.isCharacterOverlapping(enemy, [...this.characters, ...newCharacters]);
      } while (isOverlapping); // å¦‚æœé‡å ï¼Œåˆ™é‡æ–°ç”Ÿæˆä½ç½®

      newCharacters.push(enemy); // å°†æ•Œäººæ·»åŠ åˆ°ä¸´æ—¶æ•°ç»„
      this.numEnemy++;

      // ... æ˜¾ç¤ºå¼¹çª—çš„ä»£ç  ...

    }

    // è®¡ç®—å‰©ä½™å¯ç”Ÿæˆçš„å®ç®±æ•°é‡
    const remainingTreasures = 3 - this.numTreasure;
    // éšæœºç”Ÿæˆ 0 åˆ° 3 ä¸ªå®ç®±ï¼Œä½†ä¸è¶…è¿‡å‰©ä½™å¯ç”Ÿæˆçš„å®ç®±æ•°é‡
    const numTreasuresToGenerate = Math.min(Math.floor(Math.random() * 4), remainingTreasures);
    for (let i = 0; i < numTreasuresToGenerate; i++) {
      let treasure: CharacterData;
      let isOverlapping: boolean;
      do {
        treasure = {
          type: 'treasure',
          name: 'å®ç®± ' + (this.numTreasure + 1),
          level: 0,
          class: '',
          hp: 0,
          maxHp: 0,
          mp: 0,
          maxMp: 0,
          strength: 0,
          dexterity: 0,
          intelligence: 0,
          avatar: 'app.media.chest',
          position: {
            x: Math.floor(Math.random() * (this.gameAreaWidth - 75)),
            y: Math.floor(Math.random() * (this.gameAreaHeight - 75))
          },
          direction: null,
          collisionRadius: 25,
          exp:0, // åˆå§‹ç»éªŒå€¼
          nextLevelExp: 100, // å‡çº§æ‰€éœ€ç»éªŒå€¼
          inventory: [], // åˆå§‹ç©ºèƒŒåŒ…
          live: true,
        };

        //æ£€æŸ¥æ–°ç”Ÿæˆçš„å®ç®±æ˜¯å¦ä¸ç°æœ‰è§’è‰²æˆ–æ­£åœ¨ç”Ÿæˆçš„æ•Œäººå’Œå®ç®±é‡å 
        isOverlapping = this.isCharacterOverlapping(treasure, [...this.characters, ...newCharacters]);
      } while (isOverlapping); // å¦‚æœé‡å ï¼Œåˆ™é‡æ–°ç”Ÿæˆä½ç½®

      newCharacters.push(treasure); // å°†å®ç®±æ·»åŠ åˆ°ä¸´æ—¶æ•°ç»„
      this.numTreasure++;

      // ... æ˜¾ç¤ºå¼¹çª—çš„ä»£ç  ...
    }

    // å°†æ–°ç”Ÿæˆçš„æ•Œäººå’Œå®ç®±æ·»åŠ åˆ° characters æ•°ç»„
    this.characters.push(...newCharacters);

    this.updateState(); // æ›´æ–°çŠ¶æ€ä»¥é‡æ–°æ¸²æŸ“ç•Œé¢
  }

  // ä¿®æ”¹ isCharacterOverlapping å‡½æ•°ï¼Œä½¿å…¶æ¥å—ä¸€ä¸ªé¢å¤–çš„æ•°ç»„ä½œä¸ºå‚æ•°
  isCharacterOverlapping(newCharacter: CharacterData, allCharacters: CharacterData[]): boolean {
    for (const existingCharacter of allCharacters) {
      // åªæ£€æŸ¥å­˜æ´»çš„è§’è‰²
      if (existingCharacter.live) {
        const distance = Math.sqrt(
          Math.pow(newCharacter.position.x - existingCharacter.position.x, 2) +
          Math.pow(newCharacter.position.y - existingCharacter.position.y, 2)
        );

        if (distance < newCharacter.collisionRadius * 3) { // è¿™é‡Œä½¿ç”¨ 3 ä½œä¸ºå€æ•°ï¼Œä»¥ç¡®ä¿è§’è‰²ä¹‹é—´æœ‰è¶³å¤Ÿçš„é—´è·
          return true; // é‡å 
        }
      }
    }

    return false; // ä¸é‡å 
  }


  @State shouldStartBattle: boolean = false; // æ˜¯å¦åº”è¯¥å¼€å§‹æˆ˜æ–—
  @State battleTarget: CharacterData | null = null; // æˆ˜æ–—ç›®æ ‡
  @State currentBattleEnemy: CharacterData | null = null; // å½“å‰æˆ˜æ–—çš„æ•Œäºº

  // åˆ¤æ–­ç©å®¶æ˜¯å¦é¢å‘æ•Œäºº
  isPlayerFacingEnemy(enemy: CharacterData): boolean {
    const playerX = this.characters[0].position.x;
    const enemyX = enemy.position.x;

    return playerX < enemyX;
  }

   // æ£€æµ‹è§’è‰²ä¹‹é—´çš„ç¢°æ’
   checkCollisions() {

     if (!this.isPlayerStopped || !this.actionEnd) {
       // ç©å®¶æ²¡æœ‰åœæ­¢ç§»åŠ¨æˆ–äº‹ä»¶æœªç»“æŸï¼Œä¸æ£€æµ‹ç¢°æ’
       return;
     }

     // éå†æ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬ç©å®¶ï¼‰
     for (let i = 0; i < this.characters.length; i++) {
       for (let j = i + 1; j < this.characters.length; j++) {
         const character1 = this.characters[i];
         const character2 = this.characters[j];

         // åªæœ‰å½“ä¸¤ä¸ªè§’è‰²éƒ½å­˜æ´»æ—¶æ‰è¿›è¡Œç¢°æ’æ£€æµ‹
         if (character1.live && character2.live) {
           // è®¡ç®—è§’è‰²ä¹‹é—´çš„è·ç¦»
           const distance = Math.sqrt(
             Math.pow(character1.position.x - character2.position.x, 2) +
             Math.pow(character1.position.y - character2.position.y, 2)
           );

           // å¦‚æœè·ç¦»å°äºä¸¤ä¸ªè§’è‰²çš„ç¢°æ’åŠå¾„ä¹‹å’Œï¼Œåˆ™è§¦å‘ç¢°æ’äº‹ä»¶
           if (distance < character1.collisionRadius + character2.collisionRadius) {
             this.handleCollision(character1, character2);
           }
         }
       }
     }
   }

  // å¤„ç†ç¢°æ’äº‹ä»¶
  handleCollision(character1: CharacterData, character2: CharacterData) {

    if (character1 === this.characters[0]) { // ç¡®ä¿æ˜¯ç©å®¶è§¦å‘äº†ç¢°æ’
      this.showMoveDialog = false; // ä¸æ˜¾ç¤ºç§»åŠ¨å¼¹çª—
      try{
        if (character2.type === 'enemy' && character2.live) {
          // ç©å®¶ä¸æ•Œäººå‘ç”Ÿç¢°æ’ï¼Œè®¾ç½®æˆ˜æ–—æ ‡å¿—
          this.shouldStartBattle = true;
          this.battleTarget = character2;
          // è·å–æ•Œäººåœ¨ characters æ•°ç»„ä¸­çš„ç´¢å¼•
          const enemyIndex = this.characters.indexOf(character2);
          if (enemyIndex > -1) {
            // å¼€å§‹æˆ˜æ–—ï¼Œå¹¶å°†æ•Œäººç´¢å¼•ä¼ é€’ç»™ startBattle å‡½æ•°
            this.startBattle(character2, enemyIndex);
          }

        } else if (character2.type === 'npc' && character2.live) {
          // ç©å®¶ä¸ NPC å‘ç”Ÿç¢°æ’ï¼Œ
          this.dialogTitle = 'è§¦å‘å¯¹è¯ï¼';
          this.npcDialogMessage = `${character2.name}ï¼šæ¬¢è¿æ¥åˆ°å†’é™©ä¸–ç•Œï¼`; // å­˜å‚¨å¯¹è¯å†…å®¹
          this.showDialog();

        } else if (character2.type === 'treasure' && character2.live) {
          // ç©å®¶ä¸å®ç®±å‘ç”Ÿç¢°æ’ï¼Œè§¦å‘å¼€å®ç®±äº‹ä»¶
          const reward = this.generateRandomReward();
          this.handleReward(reward); // ç›´æ¥è°ƒç”¨ handleReward å‡½æ•°
          // å°†å®ç®±çš„ live å±æ€§è®¾ç½®ä¸º false
          character2.live = false;
          // ä» characters æ•°ç»„ä¸­åˆ é™¤å®ç®±
          const index = this.characters.indexOf(character2);
          if (index > -1) {
            this.characters.splice(index, 1);
            this.numTreasure--;
          }
        }
      } catch (error) {
        let message = (error as BusinessError).message;
        let code = (error as BusinessError).code;
        console.error(`showDialog args error code is ${code}, message is ${message}`);
      }
    }
  }


  // è®¡ç®—ä¼¤å®³
  calculateDamage(attacker: CharacterData, defender: CharacterData): number {
    let damage = attacker.strength;if (attacker === this.characters[0] && attacker.mp > 0) { // åªæœ‰ç©å®¶ä¼šæ¶ˆè€— MP
      damage += attacker.intelligence * attacker.mp;
      attacker.mp -= Math.floor(attacker.maxMp / 5); // æ¶ˆè€— 1/5 çš„ MP
    }
    return damage;
  }

  // è®¡ç®—é˜²å¾¡
  calculateDefense(defender: CharacterData): number {
    return defender.intelligence * defender.dexterity; // é˜²å¾¡å€¼åªç”±æ™ºåŠ›å’Œæ•æ·ç»„æˆ
  }
  // è®¡ç®—é—ªé¿ç‡
  calculateDodgeRate(attacker: CharacterData, defender: CharacterData): number {
    return Math.min(0.2, (attacker.intelligence * attacker.dexterity) / (defender.strength * 3)); // æœ€å¤§é—ªé¿ç‡ä¸º 0.2ï¼Œå¹¶é™ä½ 5 å€
  }


  // å¼€å§‹æˆ˜æ–—
  startBattle(enemy: CharacterData, enemyIndex: number) {

    if (this.currentBattleEnemy === enemy) {
      // å·²ç»åœ¨ä¸è¿™ä¸ªæ•Œäººæˆ˜æ–—ï¼Œä¸å¼€å§‹æ–°çš„æˆ˜æ–—
      return;
    }

    if (this.actionStart) {
      // å·²ç»åœ¨äº‹ä»¶ä¸­ï¼Œä¸å¼€å§‹æ–°çš„æˆ˜æ–—
      return;
    }

    this.currentBattleEnemy = enemy;
    // æˆ˜æ–—å¼€å§‹æ—¶é‡ç½®æ ‡è¯†ç¬¦
    this.actionStart = true;
    this.actionEnd = false;


    // è®¡ç®—ä¼¤å®³ã€é˜²å¾¡å’Œé—ªé¿ç‡
    const playerDamage = this.calculateDamage(this.characters[0], enemy);
    const enemyDamage = this.calculateDamage(enemy, this.characters[0]);
    const playerDefense = this.calculateDefense(this.characters[0]);
    const enemyDefense = this.calculateDefense(enemy);
    const playerDodgeRate = this.calculateDodgeRate(this.characters[0], enemy);
    const enemyDodgeRate = this.calculateDodgeRate(enemy, this.characters[0]);

    // æ„å»ºæˆ˜æ–—æŠ¥å‘Š
    let battleReport = '';

    // ç©å®¶æ”»å‡»
    if (Math.random() < enemyDodgeRate) {
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\né—ªé¿\n`;
    } else {
      const actualPlayerDamage = Math.max(0, playerDamage - enemyDefense);
      enemy.hp -= actualPlayerDamage;
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\n${enemy.name}å—ä¼¤\n${actualPlayerDamage} ç‚¹\n`;
    }


    // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
    if (enemy.hp <= 0) {
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\n${enemy.name} æ­»äº¡ï¼\n`;
      this.handleEnemyDeath(enemy); // å¤„ç†æ•Œäººæ­»äº¡
      this.battleReportAbovePlayer = battleReport; // æ›´æ–°æˆ˜æ–—æŠ¥å‘Š
      this.actionStart = false;
      this.actionEnd = true;
      return; // ç»ˆæ­¢æˆ˜æ–—
    }

    // æ•Œäººæ”»å‡»
    if (Math.random() < playerDodgeRate) {
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\né—ªé¿\n`;
    } else {
      const actualEnemyDamage = Math.max(0, enemyDamage - playerDefense);
      this.characters[0].hp -= actualEnemyDamage;
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\n${enemy.name}å—ä¼¤\n${actualEnemyDamage}ç‚¹\n`;
    }

    // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
    if (this.characters[0].hp <= 0) {
      battleReport += `âš”ï¸æˆ˜æ–—æŠ¥å‘Šâš”ï¸\nä½ æ­»äº¡äº†ï¼\n`;
      this.handlePlayerDeath(); // å¤„ç†ç©å®¶æ­»äº¡
      this.battleReportAbovePlayer = battleReport; // æ›´æ–°æˆ˜æ–—æŠ¥å‘Š
      this.actionStart = false;
      this.actionEnd = true;
      return; // ç»ˆæ­¢æˆ˜æ–—
    }

    // å°†æˆ˜æ–—æŠ¥å‘Šå­˜å‚¨åœ¨ battleReportAboveEnemy ä¸­
    this.battleReportAboveEnemy.set(enemy, battleReport); // åœ¨æ¯æ¬¡æˆ˜æ–—æ—¶æ›´æ–°æˆ˜æ–—æŠ¥å‘Š
    this.battleReportAbovePlayer = battleReport;

    // è®¾ç½®æˆ˜æ–—æŠ¥å‘Šçš„ç›®æ ‡ä½ç½®
    this.battleReportTargetY = this.characters[0].position.y - 30; // å‘ä¸Šç§»åŠ¨ 30 åƒç´ 

    // å¯åŠ¨é£˜å­—åŠ¨ç”»
    animateTo({ duration: 100 }, () => {
      // åœ¨åŠ¨ç”»çš„æ¯ä¸€å¸§æ›´æ–°æˆ˜æ–—æŠ¥å‘Šçš„ä½ç½®
      this.battleReportPositionY = this.battleReportTargetY;

      // åœ¨åŠ¨ç”»ç»“æŸåæ¸…ç©ºæˆ˜æ–—æŠ¥å‘Š
      this.battleReportAbovePlayer = '';
      this.battleReportTargetY = 0;
      this.battleReportPositionY = 0;
    });

    // æˆ˜æ–—ç»“æŸåé‡ç½®æ ‡è¯†ç¬¦
    this.actionStart = false;
    this.actionEnd = true;

    // æ‰‹åŠ¨è§¦å‘é‡æ–°æ¸²æŸ“
    this.renderTrigger++;

    this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // å¤„ç†æ•Œäººæ­»äº¡
  handleEnemyDeath(enemy: CharacterData) {

    enemy.live = false; // å°†æ•Œäººçš„å­˜æ´»çŠ¶æ€è®¾ç½®ä¸º false

    // å¥–åŠ±ç»éªŒå€¼å’Œé“å…·
    const expGain = 10; // å¯ä»¥æ ¹æ®æ•Œäººç­‰çº§è°ƒæ•´
    const itemGain = this.getRandomItem();

    this.characters[0].exp += expGain;
    this.characters[0].inventory.push(itemGain);

    this.dialogTitle = 'âš”ï¸æˆ˜æ–—èƒœåˆ©âš”ï¸';
    this.dialogMessage = 'ä½ è·å¾—äº† ' + expGain + ' ç‚¹ç»éªŒå€¼å’Œ' + itemGain.name + '\n';
    this.showDialog();


    this.characters[0].exp += expGain;
    this.characters[0].inventory.push(itemGain);

    // ä» characters æ•°ç»„ä¸­åˆ é™¤æ•Œäºº
    const index = this.characters.indexOf(enemy);
    if (index > -1) {
      this.characters.splice(index, 1);
      this.numEnemy--;
      this.enemyAndTreasureNames.delete(index);
    }

    // æ£€æŸ¥æ˜¯å¦å‡çº§
    this.checkLevelUp();

    // æ‰‹åŠ¨è§¦å‘é‡æ–°æ¸²æŸ“
    this.renderTrigger++;

    this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // å¤„ç†ç©å®¶æ­»äº¡
  handlePlayerDeath() {

    this.characters[0].live = false; // å°†ç©å®¶çš„å­˜æ´»çŠ¶æ€è®¾ç½®ä¸º false
    // æ¸¸æˆç»“æŸ
    this.dialogTitle = 'â˜ æ­»äº¡æŠ¥å‘Šâ˜ ';
    this.dialogMessage = 'ä½ å¤±è´¥äº†ï¼';
    this.showDialog();

    //this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // è·å–éšæœºé“å…·
  getRandomItem(): ItemData {
    // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„é“å…·æ‰è½é€»è¾‘
    const items: ItemData[] = [
      {
        name: 'ç”Ÿå‘½è¯æ°´',
        description: 'æ¢å¤ 50 ç‚¹ç”Ÿå‘½å€¼',
        type: 'consumable',
        effect: (character: CharacterData) => {
          character.hp = Math.min(character.hp + 50, character.maxHp);
        }
      },
    // æ·»åŠ æ›´å¤šé“å…·...
    ];
    const randomIndex = Math.floor(Math.random() * items.length);
    return items[randomIndex];
  }

  // æ£€æŸ¥æ˜¯å¦å‡çº§
  checkLevelUp() {
    if (this.characters[0].exp >= this.characters[0].nextLevelExp) {
      // å‡çº§
      this.characters[0].level++;
      this.characters[0].exp = 0;
      this.characters[0].nextLevelExp *= 1.5; // å‡çº§æ‰€éœ€ç»éªŒå€¼å¢åŠ 

      // æé†’ç©å®¶å‰å¾€äººç‰©é¡µé¢å¢åŠ å±æ€§ç‚¹
      this.dialogTitle = 'ä½ å‡çº§äº†';
      this.dialogMessage = 'ä½ å‡çº§äº†ï¼è¯·å‰å¾€äººç‰©é¡µé¢å¢åŠ å±æ€§ç‚¹';
      this.showDialog();
    }
    this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // ç”Ÿæˆéšæœºå¥–åŠ±
  generateRandomReward(): RewardData {
  const rewardTypes = ['gold', 'weapon', 'keyItem'];
  const randomType = rewardTypes[Math.floor(Math.random() * rewardTypes.length)];

  switch (randomType) {
     case 'gold':
       return {
         type: 'gold',
         amount: Math.floor(Math.random() * 100) + 1 // éšæœºè·å¾— 1-100 é‡‘å¸
       };
      case 'weapon':
        return {
          type: 'weapon',
          name: 'ç¥ç§˜ä¹‹å‰‘', // æ›¿æ¢ä¸ºä½ å®é™…çš„æ­¦å™¨åç§°
          description: 'ä¸€æŠŠæ•£å‘ç€ç¥ç§˜æ°”æ¯çš„å‰‘' // æ›¿æ¢ä¸ºä½ å®é™…çš„æ­¦å™¨æè¿°
        };
      case 'keyItem':
        return {
          type: 'keyItem',
          name: 'å¤è€çš„é’¥åŒ™', // æ›¿æ¢ä¸ºä½ å®é™…çš„ä»»åŠ¡é“å…·åç§°
          description: 'ä¸€æŠŠçœ‹èµ·æ¥éå¸¸å¤è€çš„é’¥åŒ™' // æ›¿æ¢ä¸ºä½ å®é™…çš„ä»»åŠ¡é“å…·æè¿°
        };
      default:
        return { type: 'gold', amount: 0 };
  }

}

  // å¤„ç†å®ç®±å¥–åŠ±
  handleReward(reward: RewardData) {

    if (this.actionStart) {
      // å·²ç»åœ¨äº‹ä»¶ä¸­ï¼Œä¸å¤„ç†æ–°çš„å¥–åŠ±äº‹ä»¶
      return;
    }

    this.actionStart = true;
    this.actionEnd = false;

    switch (reward.type) {
      case 'gold':
      // å°†é‡‘å¸æ·»åŠ åˆ°ç©å®¶èƒŒåŒ…ï¼ˆæˆ–ç›´æ¥å¢åŠ ç©å®¶çš„é‡‘å¸æ•°é‡ï¼‰
        this.battleReportAbovePlayer = `ğŸ’å‘ç°äº†å®ç®±ï¼ğŸ’\nä½ è·å¾—äº† ${reward.amount} é‡‘å¸ï¼`;
        break;
      case 'weapon':
      // å°†æ­¦å™¨æ·»åŠ åˆ°ç©å®¶èƒŒåŒ…
        this.characters[0].inventory.push({
          name: reward.name!,
          description: reward.description!,
          type: 'equipment',
          effect: (character: CharacterData) => {
            // å®ç°æ­¦å™¨çš„æ•ˆæœ
          }
        });
        this.battleReportAbovePlayer = `ğŸ’å‘ç°äº†å®ç®±ï¼ğŸ’\nä½ è·å¾—äº† ${reward.name}ï¼`;
        break;
      case 'keyItem':
      // å°†ä»»åŠ¡é“å…·æ·»åŠ åˆ°ç©å®¶èƒŒåŒ…
        this.characters[0].inventory.push({
          name: reward.name!,
          description: reward.description!,
          type: 'keyItem',
          effect: (character: CharacterData) => {
            // å®ç°ä»»åŠ¡é“å…·çš„æ•ˆæœ
          }
        });
        this.battleReportAbovePlayer = `ğŸ’å‘ç°äº†å®ç®±ï¼ğŸ’\nä½ è·å¾—äº† ${reward.name}ï¼`;
        break;
    }

    this.showDialog();
    this.actionStart = false;
    this.actionEnd = true;

    this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
  }

  // èƒŒåŒ…å¼¹çª—
  showInventoryDialog() {
    let message = 'ä½ çš„èƒŒåŒ…ï¼š\n';
    const itemCounts = new Map<string, number>();

    // ç»Ÿè®¡æ¯ç§ç‰©å“çš„æ•°é‡
    this.characters[0].inventory.forEach((item) => {
      if (itemCounts.has(item.name)) {
        itemCounts.set(item.name, itemCounts.get(item.name)! + 1);
      } else {
        itemCounts.set(item.name, 1);
      }
    });

    // æ˜¾ç¤ºç‰©å“æ•°é‡
    if (itemCounts.size === 0) {
      message += 'ç©ºç©ºå¦‚ä¹Ÿï¼';
    } else {
      itemCounts.forEach((count, itemName) => {
        message += `${itemName} x${count}\n`;
      });
    }

    try {
      promptAction.showDialog({
        title: 'èƒŒåŒ…',
        message: message,
        buttons: []
      });
    } catch (error) {
      let message = (error as BusinessError).message;
      let code = (error as BusinessError).code;
      console.error(`showDialog args error code is ${code}, message is ${message}`);
    }
  }

  // è°ƒè¯•åŠŸèƒ½ï¼šæ˜¾ç¤ºæ‰€æœ‰è§’è‰²çš„æ‰€æœ‰ä¿¡æ¯
  showCharacterPositions() {
    let message = '';
    this.characters.forEach((character, index) => {
      message += `è§’è‰²${index + 1} (${character.type}):\n`;
      message += `  åç§°: ${character.name}\n`;
      message += `  ç­‰çº§: ${character.level}\n`;
      message += `  èŒä¸š: ${character.class}\n`;
      message += `  ç”Ÿå‘½å€¼: ${character.hp}/${character.maxHp}\n`;
      message += `  é­”æ³•å€¼: ${character.mp}/${character.maxMp}\n`;
      message += `  åŠ›é‡: ${character.strength}\n`;
      message += `  æ•æ·: ${character.dexterity}\n`;
      message += `  æ™ºåŠ›: ${character.intelligence}\n`;
      message += `  ä½ç½®: (${character.position.x}, ${character.position.y})\n`;
      message += `  ç¢°æ’åŠå¾„: ${character.collisionRadius}\n\n`;
    });

    try {
      promptAction.showDialog({
        title: 'è§’è‰²ä¿¡æ¯',
        message: message,
        buttons: []
      });
    } catch (error) {
      let message = (error as BusinessError).message;
      let code = (error as BusinessError).code;
      console.error(`showDialog args error code is ${code}, message is ${message}`);
    }
  }



  build() {
    Stack() {

      // æ˜¾ç¤º NPC å¯¹è¯å†…å®¹
      if (this.npcDialogMessage !== '') {
        Text(this.npcDialogMessage)
          .fontSize(16)
          .fontColor(Color.White)
          .width('100%')
          .textAlign(TextAlign.Center)
          .position({ x:0, y: 200 }) // è°ƒæ•´ä½ç½®ä½¿å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸­å¤®
      }

      // åœ°é¢ç½‘æ ¼
      Grid() {
        ForEach(new Array(Math.ceil(this.gameAreaWidth / 71) + 2).fill(0), (item: void, columnIndex: number) => { // å¢åŠ  2 åˆ—ç¼“å†²åŒº
          GridItem() {
            Column() {
              ForEach(new Array(Math.ceil(this.gameAreaHeight / 71) + 2).fill(0), (item: void, rowIndex: number) => { // å¢åŠ  2 è¡Œç¼“å†²åŒº
                //éšæœºé€‰æ‹©è‰åœ°æˆ–çŸ³å¤´ç´ æ
                if (Math.random() < 0.5) {
                  Image($r('app.media.grass'))
                    .width(71)
                    .height(71)
                } else {
                  Image($r('app.media.stone_l'))
                    .width(71)
                    .height(71)
                }
              })
            }
          }
        })
      }
      .width('100%')
      .height('100%')

      Row(){
        // ç©å®¶å¤´é¡¶çš„æˆ˜æ–—æŠ¥å‘Š
        Text(this.battleReportAbovePlayer)
          .position({ x: this.characters[0].position.x - 55, y: this.characters[0].position.y - 45 })
          .fontSize(18)
          .fontColor(Color.Black)
          .backgroundColor(Color.Gray)
          .zIndex(20)
        // è§’è‰²
        Image($r('app.media.knight'))
          .width(50)
          .height(50)
          .position({ x: this.characters[0].position.x, y: this.characters[0].position.y })
          .key(this.characterPositionKey.toString()) // ä½¿ç”¨ characterPositionKey ä½œä¸º key
          .scale({ x: this.isFlipped ? -1 : 1, y: 1 }) // æ ¹æ® isFlipped ç¿»è½¬å›¾ç‰‡
          .zIndex(10)
      }

      // NPC
      ForEach(this.characters, (item: CharacterData, index: number) => {
        if (item.type === 'npc') {
          Image($r(item.avatar))
            .width(50)
            .height(50)
            .position({ x: item.position.x, y: item.position.y })
            .key(index.toString())
            .zIndex(5)
        }
      }, (item: CharacterData) => JSON.stringify(item))

      // æ•Œäººå’Œå®ç®±
      ForEach(this.characters, (item: CharacterData, index: number) => {
        if (item.type === 'enemy' || item.type === 'treasure') {
          if (item.live) { // åªæ¸²æŸ“å­˜æ´»çš„æ•Œäººå’Œå®ç®±
            Stack() {
              Image($r(item.avatar))
                .width(50)
                .height(50)// ç§»é™¤ position å±æ€§ï¼Œç›´æ¥ä½¿ç”¨ item.position.x å’Œ item.position.y
                .key(index.toString())// æ•Œäººå›¾ç‰‡æœå‘ç©å®¶
                .scale({
                  x: item.type === 'enemy' && this.isPlayerFacingEnemy(item) ? -1 : 1,
                  y: 1
                })
              // æ˜¾ç¤ºæ•Œäººå’Œå®ç®±çš„åå­—
              Text(this.enemyAndTreasureNames.get(index) || '')
                .fontSize(12)
                .fontColor(Color.Red)
                .position({ x: 0, y: -20 })
            }
            .key(this.renderTrigger.toString())
            .width(50)
            .height(70)
            .zIndex(5)
            // åœ¨ ForEach å¾ªç¯ä¸­è®¾ç½®å›¾ç‰‡çš„ä½ç½®
            .position({ x: item.position.x, y: item.position.y })
            .key(item.name) // ä½¿ç”¨ item.name ä½œä¸º key
            .onAppear(() => {
              // åœ¨æ•Œäººå’Œå®ç®±å‡ºç°æ—¶ï¼Œå°†å…¶åå­—å­˜å‚¨åœ¨ enemyAndTreasureNames ä¸­
              this.enemyAndTreasureNames.set(index, item.name);
            })
          }
        }
      }, (item: CharacterData) => JSON.stringify(item))




      // UI å…ƒç´ 
      Column() {
        Text('è§’è‰²åç§°')
          .fontSize(25)
          .margin({ top: 10, left: 10 })
          .fontColor(Color.Red)
          .zIndex(30)

        // ç©å®¶ç­‰çº§å’Œç»éªŒæ¡
        Row() {
          Text(`ç­‰çº§: ${this.characters[0].level}`)
            .fontSize(18)
            .fontColor(Color.Red)
          Progress({ value: this.characters[0].exp , total: this.characters[0].nextLevelExp })
            .style({
              borderColor: Color.Blue,
              borderWidth: 1,
              content: `${this.characters[0].exp}/${this.characters[0].nextLevelExp}`,
              font: {size: 16, style: FontStyle.Normal},
              fontColor: Color.Red,
              enableScanEffect: false,
              showDefaultPercentage: false})
            .width(100)
            .height(50)
            .margin({ left: 10 }) // æ·»åŠ å·¦è¾¹è·
            .backgroundColor(Color.Gray)
        }
        .margin({ top: 5, left: 10, right: 10 })
        .zIndex(30)

        // è¡€æ¡å’Œè“æ¡
        Row() {
          // è¡€æ¡
          Row() {
            Text('HP: ')
              .fontSize(18)
              .fontColor(Color.Red)
            Shape()
            .width((this.characters[0].hp / this.characters[0].maxHp) * 100)
            .height(10)
            .borderRadius(5)
              .backgroundColor(Color.Red)
              .key(`hpBar-${this.characters[0].hp}`) // æ·»åŠ  key å±æ€§
            }
          .margin({ right: 50 })

          // è“æ¡
          Row() {
            Text('MP: ')
              .fontSize(18)
              .fontColor(Color.Blue)
            Shape()
            .width((this.characters[0].mp / this.characters[0].maxMp) * 100)
            .height(10)
            .borderRadius(5)
            .backgroundColor(Color.Blue)
              .key(`mpBar-${this.characters[0].mp}`) // æ·»åŠ  key å±æ€§
            }
          .margin({ left: 10 })
        }.
        margin({ top: 5, left: 10, right: 10 }) // æ·»åŠ  margin ä»¥ä¿æŒé—´è·
        .width('100%')
        .align(Alignment.TopStart)
        .zIndex(30)

        // ä¸Šä¸‹å·¦å³æŒ‰é’®åŒºåŸŸ
        Column() {
          Blank()
            .height('70%')
          // æ§åˆ¶å™¨åŒºåŸŸ
          Row() {
            // ä¸ŠæŒ‰é’®
            Button(){
              Image($r('app.media.up'))
                .width(50)
                .height(50)
            }
            .width(50) // è®¾ç½®æŒ‰é’®å®½åº¦
            .height(50) // è®¾ç½®æŒ‰é’®é«˜åº¦
            .onClick((event: ClickEvent) => { // ä¿®æ”¹ onClick äº‹ä»¶
              this.moveCharacter('up');
              this.buttonPressed = 'up'; // è®°å½•æŒ‰ä¸‹çš„æŒ‰é’®
            })
            .stateStyles({
              pressed: {
                opacity: 0.5 // æŒ‰ä¸‹æ—¶é™ä½é€æ˜åº¦
              },
              normal: {
                opacity: 1 // æ­£å¸¸çŠ¶æ€ä¸‹æ¢å¤é€æ˜åº¦
              }
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Up) {
                this.buttonPressed = null; // é‡Šæ”¾æŒ‰é’®æ—¶æ¸…ç©ºè®°å½•
                this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
              }
            })

            // ä¸‹æŒ‰é’®
            Button(){
              Image($r('app.media.down'))
                .width(50)
                .height(50)
            }
            .width(50) // è®¾ç½®æŒ‰é’®å®½åº¦
            .height(50) // è®¾ç½®æŒ‰é’®é«˜åº¦
            .gesture(
              TapGesture()
                .onAction((event: GestureEvent)=> {
                  this.moveCharacter('down');
                  this.buttonPressed = 'up'; // è®°å½•æŒ‰ä¸‹çš„æŒ‰é’®
                })
            )
            .stateStyles({
              pressed: {
                opacity: 0.5 // æŒ‰ä¸‹æ—¶é™ä½é€æ˜åº¦
              },
              normal: {
                opacity: 1 // æ­£å¸¸çŠ¶æ€ä¸‹æ¢å¤é€æ˜åº¦
              }
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Up) {
                this.buttonPressed = null; // é‡Šæ”¾æŒ‰é’®æ—¶æ¸…ç©ºè®°å½•
                this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
              }
            })

            // å·¦æŒ‰é’®
            Button(){
              Image($r('app.media.left'))
                .width(50)
                .height(50)
            }
            .width(50) // è®¾ç½®æŒ‰é’®å®½åº¦
            .height(50) // è®¾ç½®æŒ‰é’®é«˜åº¦
            .gesture(
              TapGesture()
                .onAction((event: GestureEvent)=> {
                  this.moveCharacter('left');
                  this.buttonPressed = 'up'; // è®°å½•æŒ‰ä¸‹çš„æŒ‰é’®
                })
            )
            .stateStyles({
              pressed: {
                opacity: 0.5 // æŒ‰ä¸‹æ—¶é™ä½é€æ˜åº¦
              },
              normal: {
                opacity: 1 // æ­£å¸¸çŠ¶æ€ä¸‹æ¢å¤é€æ˜åº¦
              }
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Up) {
                this.buttonPressed = null; // é‡Šæ”¾æŒ‰é’®æ—¶æ¸…ç©ºè®°å½•
                this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
              }
            })

            // å³æŒ‰é’®
            Button(){
              Image($r('app.media.right'))
                .width(50)
                .height(50)
            }
            .width(50) // è®¾ç½®æŒ‰é’®å®½åº¦
            .height(50) // è®¾ç½®æŒ‰é’®é«˜åº¦
            .gesture(
              TapGesture()
                .onAction((event: GestureEvent)=> {
                  this.moveCharacter('right');
                  this.buttonPressed = 'up'; // è®°å½•æŒ‰ä¸‹çš„æŒ‰é’®
                })
            )
            .stateStyles({
              pressed: {
                opacity: 0.5 // æŒ‰ä¸‹æ—¶é™ä½é€æ˜åº¦
              },
              normal: {
                opacity: 1 // æ­£å¸¸çŠ¶æ€ä¸‹æ¢å¤é€æ˜åº¦
              }
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Up) {
                this.buttonPressed = null; // é‡Šæ”¾æŒ‰é’®æ—¶æ¸…ç©ºè®°å½•
                this.updateState(); // è§¦å‘é‡æ–°æ¸²æŸ“
              }
            })

            // èƒŒåŒ…æŒ‰é”®
            Button(){
              Image($r('app.media.backpack'))
                .width(75)
                .height(75)
            }
            .onClick((event: ClickEvent) => { // ä¿®æ”¹ onClick äº‹ä»¶
              this.showInventoryDialog();
              this.renderTrigger ++ ;

            })
            .width(75) // è®¾ç½®æŒ‰é’®å®½åº¦
            .height(75) // è®¾ç½®æŒ‰é’®é«˜åº¦
            .margin({ left: 70 }) // æ·»åŠ å·¦è¾¹è·


          }
          .width('100%')
          .height('15%') // è®¾ç½®ç©å®¶æ“ä½œåŒºåŸŸçš„é«˜åº¦

          Blank()
            .height('15%')

        }
        .width('100%')
        .zIndex(30)
      }
      .width('100%')
      .height('100%')

    }
  }
}